#!/usr/bin/env bash
set -euo pipefail

# MARL experiment batch 3: VDN shared baseline
# vdn_shared

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "${PROJECT_ROOT}"

SEED="${SEED:-0}"
OUTPUT_ROOT="${OUTPUT_ROOT:-outputs}"

TOTAL_TIMESTEPS="${TOTAL_TIMESTEPS:-2000000}"
EPS_DECAY_STEPS="${EPS_DECAY_STEPS:-1600000}"

timestamp="$(date -u +%Y%m%dT%H%M%SZ)"
run_root="${OUTPUT_ROOT}/exp_3_vdn_shared_${timestamp}_seed${SEED}"

mkdir -p "${run_root}/logs"

PYTHON_BIN=""
if [[ -f "${HOME}/.venv/bin/activate" ]]; then
  # shellcheck disable=SC1090
  source "${HOME}/.venv/bin/activate"
  PYTHON_BIN="python"
elif command -v python >/dev/null 2>&1; then
  PYTHON_BIN="python"
elif command -v python3 >/dev/null 2>&1; then
  PYTHON_BIN="python3"
else
  echo "Could not find python or python3 (and ~/.venv not found)." >&2
  exit 1
fi

config_path="configs/marl_absolute_plants.json"
if [[ ! -f "${config_path}" ]]; then
  echo "Config not found: ${config_path}" >&2
  exit 1
fi

next_run_dir() {
  local algo="$1"
  local idx=0
  local candidate
  while :; do
    candidate="${run_root}/${algo}_${idx}"
    if [[ ! -d "${candidate}" ]]; then
      echo "${candidate}"
      return 0
    fi
    idx=$((idx + 1))
  done
}

run_one() {
  local algo_module="$1"
  local algo_label="$2"
  local run_label="$3"
  shift 3

  local common_args=(
    --config "${config_path}"
    --output-root "${run_root}"
    --seed "${SEED}"
    --total-timesteps "${TOTAL_TIMESTEPS}"
    --n-eval-episodes 10
  )

  local log_path="${run_root}/logs/${run_label}.log"
  local expected_dir
  expected_dir="$(next_run_dir "${algo_label}")"

  echo "=== ${run_label} ==="
  echo "Logging to: ${log_path}"
  echo "Expected run dir: ${expected_dir}"

  PYTHONUNBUFFERED=1 "${PYTHON_BIN}" -m "${algo_module}" "${common_args[@]}" "$@" 2>&1 | tee "${log_path}"

  local final_dir="${run_root}/${run_label}"
  if [[ ! -d "${expected_dir}" ]]; then
    echo "Expected run dir missing: ${expected_dir}" >&2
    exit 1
  fi
  if [[ -e "${final_dir}" ]]; then
    echo "Target run dir already exists: ${final_dir}" >&2
    exit 1
  fi
  mv "${expected_dir}" "${final_dir}"
}

run_one "algorithms.marl_vdn" "vdn" "vdn_shared" \
  --epsilon-decay-steps "${EPS_DECAY_STEPS}"--batch-size 512 --learning-rate 0.00025

zip_path="${run_root}.zip"
if command -v zip >/dev/null 2>&1; then
  (cd "${OUTPUT_ROOT}" && zip -qr "$(basename "${zip_path}")" "$(basename "${run_root}")")
else
  "${PYTHON_BIN}" - <<PY
import zipfile
from pathlib import Path

src = Path("${run_root}")
dst = Path("${zip_path}")
with zipfile.ZipFile(dst, "w", compression=zipfile.ZIP_DEFLATED) as zf:
    for p in src.rglob("*"):
        zf.write(p, p.relative_to(src.parent))
print(f"Wrote zip: {dst}")
PY
fi

echo "Done."
echo "Run root: ${run_root}"
echo "Zipped to: ${zip_path}"
