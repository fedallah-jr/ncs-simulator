#!/usr/bin/env bash
set -euo pipefail

# MARL experiment batch 5: HAPPO (independent actors, sequential update, ValueNorm)
# Phase 1 (7.5M steps): kf_info_m reward
# Phase 2 (+7.5M steps): resume, kf_info_m_noise reward

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "${PROJECT_ROOT}"

SEED="${SEED:-0}"
OUTPUT_ROOT="${OUTPUT_ROOT:-outputs}"

PHASE1_TIMESTEPS="${PHASE1_TIMESTEPS:-7500000}"
PHASE2_TIMESTEPS="${PHASE2_TIMESTEPS:-15000000}"

timestamp="$(date -u +%Y%m%dT%H%M%SZ)"
run_root="${OUTPUT_ROOT}/exp_5_happo_${timestamp}_seed${SEED}"

mkdir -p "${run_root}/logs"

PYTHON_BIN=""
if [[ -f "${HOME}/.venv/bin/activate" ]]; then
  # shellcheck disable=SC1090
  source "${HOME}/.venv/bin/activate"
  PYTHON_BIN="python"
elif command -v python >/dev/null 2>&1; then
  PYTHON_BIN="python"
elif command -v python3 >/dev/null 2>&1; then
  PYTHON_BIN="python3"
else
  echo "Could not find python or python3 (and ~/.venv not found)." >&2
  exit 1
fi

config_path="${CONFIG_PATH:-configs/marl_absolute_plants.json}"
if [[ ! -f "${config_path}" ]]; then
  echo "Config not found: ${config_path}" >&2
  exit 1
fi

next_run_dir() {
  local algo="$1"
  local idx=0
  local candidate
  while :; do
    candidate="${run_root}/${algo}_${idx}"
    if [[ ! -d "${candidate}" ]]; then
      echo "${candidate}"
      return 0
    fi
    idx=$((idx + 1))
  done
}

run_one() {
  local algo_module="$1"
  local algo_label="$2"
  local run_label="$3"
  shift 3

  local common_args=(
    --config "${config_path}"
    --output-root "${run_root}"
    --seed "${SEED}"
    --total-timesteps "${PHASE1_TIMESTEPS}"
    --eval-freq 15000
    --n-eval-episodes 50
    --episode-length 250
  )

  local log_path="${run_root}/logs/${run_label}.log"
  local expected_dir
  expected_dir="$(next_run_dir "${algo_label}")"

  echo "=== ${run_label} ==="
  echo "Logging to: ${log_path}"
  echo "Expected run dir: ${expected_dir}"

  PYTHONUNBUFFERED=1 "${PYTHON_BIN}" -m "${algo_module}" "${common_args[@]}" "$@" 2>&1 | tee "${log_path}"

  local final_dir="${run_root}/${run_label}"
  if [[ ! -d "${expected_dir}" ]]; then
    echo "Expected run dir missing: ${expected_dir}" >&2
    exit 1
  fi
  if [[ -e "${final_dir}" ]]; then
    echo "Target run dir already exists: ${final_dir}" >&2
    exit 1
  fi
  mv "${expected_dir}" "${final_dir}"
}

# --- Phase 1: kf_info_m reward ---
run_one "algorithms.marl_happo" "happo" "happo" \
  --no-normalize-obs \
  --feature-norm \
  --layer-norm \
  --set reward.state_error_reward=kf_info_m \
  --set reward.normalize=false

resume_dir="${run_root}/happo"

# --- Phase 2: resume, kf_info_m_noise reward ---
echo "=== happo (phase 2: kf_info_m_noise) ==="
echo "Resuming from: ${resume_dir}"
echo "Total timesteps: ${PHASE2_TIMESTEPS}"

PYTHONUNBUFFERED=1 "${PYTHON_BIN}" -m algorithms.marl_happo \
  --config "${config_path}" \
  --resume "${resume_dir}" \
  --seed "${SEED}" \
  --total-timesteps "${PHASE2_TIMESTEPS}" \
  --eval-freq 15000 \
  --n-eval-episodes 50 \
  --episode-length 250 \
  --no-normalize-obs \
  --feature-norm \
  --layer-norm \
  --set reward.state_error_reward=kf_info_m_noise \
  --set reward.normalize=false \
  2>&1 | tee "${run_root}/logs/happo_phase2.log"

zip_path="${run_root}.zip"
if command -v zip >/dev/null 2>&1; then
  (cd "${OUTPUT_ROOT}" && zip -qr "$(basename "${zip_path}")" "$(basename "${run_root}")")
else
  "${PYTHON_BIN}" - <<PY
import zipfile
from pathlib import Path

src = Path("${run_root}")
dst = Path("${zip_path}")
with zipfile.ZipFile(dst, "w", compression=zipfile.ZIP_DEFLATED) as zf:
    for p in src.rglob("*"):
        zf.write(p, p.relative_to(src.parent))
print(f"Wrote zip: {dst}")
PY
fi

echo "Done."
echo "Run root: ${run_root}"
echo "Zipped to: ${zip_path}"
